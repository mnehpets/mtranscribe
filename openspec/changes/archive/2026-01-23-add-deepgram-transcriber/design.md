# Design: Deepgram Transcriber & Global Config

## Architecture

### Global Configuration
A singleton class `AppConfig` will be created in `src/Config.ts`. This class will be responsible for holding application-wide configuration, starting with the `deepgramApiKey`.

```typescript
export class AppConfig {
  private static instance: AppConfig;
  public deepgramApiKey: string = '';

  private constructor() {}

  static getInstance(): AppConfig {
    if (!AppConfig.instance) {
      AppConfig.instance = new AppConfig();
    }
    return AppConfig.instance;
  }
}
```

### Transcript Model Updates
To support real-time updates from multiple parallel sources (e.g. user typing notes while Deepgram transcribes), the `Transcript` model will support **multiple active turns** keyed by their source.

*   **State**: `activeTurns`: A map/dictionary tracking the current incomplete turn for each `TurnSource`.
*   **Turn Interface**: 
    *   `source`: `'transcribed' | 'typed' | 'generated'`
    *   `text`: Stable committed text.
    *   `interim`: Volatile text.
*   `updateInterim(text: string, source: TurnSource)`: 
    *   Finds or creates the active turn for `source`.
    *   **Replaces** the `interim` field.
*   `appendInterim(delta: string, source: TurnSource)`:
    *   Finds or creates the active turn for `source`.
    *   **Appends** to the `interim` field.
*   `appendStable(text: string, source: TurnSource)`:
    *   Finds or creates the active turn for `source`.
    *   **Appends** to `text` and clears `interim`.
*   `finalizeTurn(source: TurnSource)`: 
    *   Finalizes the active turn for `source`.
    *   Removes it from the `activeTurns` map.

This ensures that if a user types while transcription is running, two distinct turns exist and update independently without fragmenting each other.

### Deepgram Transcriber
...
## Data Flow
...
6.  Deepgram SDK receives events:
    *   **Interim Results** (`is_final=false`): Calls `transcript.updateInterim(text, 'transcribed')`.
    *   **Final Results** (`is_final=true`): Calls `transcript.appendStable(text, 'transcribed')`.
    *   **Utterance End**: Calls `transcript.finalizeTurn('transcribed')`.
7.  The `Transcript` object updates its state...

### Deepgram Transcriber
A `DeepgramTranscriber` class will encapsulate the transcription logic using the official `@deepgram/sdk`. It will:
1.  Read the API key from `AppConfig`.
2.  Initialize the Deepgram client and establish a live transcription connection.
3.  Configure the connection to:
    *   Enable `interim_results`.
    *   Enable `utterance_end_ms` (e.g. default 1000ms) to detect end of speech.
    *   Disable data logging (opt-out of model improvement).
4.  Stream audio data to the Deepgram service.
5.  Populate a connected `Transcript` object.

**API Interface:**
```typescript
class DeepgramTranscriber {
    constructor(config: AppConfig);
    
    // Attaches a transcript object to receive updates.
    attach(transcript: Transcript): void;
    
    // Starts the connection and audio processing.
    start(): Promise<void>;
    
    // Stops the connection.
    stop(): void;
    
    // Feeds audio data to the transcriber.
    sendAudio(data: Blob): void;
}
```

## Data Flow
1.  User/App initializes `AppConfig` with an API Key.
2.  `DeepgramTranscriber` is instantiated.
3.  A `Transcript` object is created and attached via `transcriber.attach(transcript)`.
4.  Audio capture (microphone) feeds binary data to `DeepgramTranscriber`.
5.  `DeepgramTranscriber` passes data to the Deepgram SDK.
6.  Deepgram SDK receives events:
    *   **Interim Results**: Calls `transcript.updateInterim(text)`.
    *   **Utterance End**: Calls `transcript.finalizeTurn()`.
7.  The `Transcript` object updates its state, which is reactive (Vue), causing the UI to update automatically.

## Security & Privacy Considerations
- **Client-side API Key**: Storing the API key in the frontend exposes it to the user. This is acceptable for the stated requirement ("runs in the frontend"), but in a production environment, we would typically use an ephemeral key generated by a backend or proxy the traffic. We will proceed with the direct key approach as requested.
- **Model Improvement Opt-out**: The configuration will explicitly set the flag to opt-out of Deepgram's model improvement program to ensure user audio is not stored or used for training.
